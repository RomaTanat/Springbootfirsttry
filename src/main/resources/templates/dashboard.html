<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base}">
<head>
    <title>–õ–∏—á–Ω—ã–π –ö–∞–±–∏–Ω–µ—Ç</title>
</head>
<body>

<div layout:fragment="content">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">üë§ –õ–∏—á–Ω—ã–π –ö–∞–±–∏–Ω–µ—Ç</h2>
            <p>–í—ã —É—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É. –≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞—â–∏—â–µ–Ω–∞ JWT-—Ç–æ–∫–µ–Ω–æ–º.</p>

            <button id="testApiButton" class="btn btn-info">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ó–∞—â–∏—â–µ–Ω–Ω—ã–π API</button>

            <div id="apiResponse" class="mt-3">
                <p>–†–µ–∑—É–ª—å—Ç–∞—Ç API-–∑–∞–ø—Ä–æ—Å–∞:</p>
                <pre id="apiData" class="p-3 bg-light border"></pre>
            </div>

            <button id="logoutButton" class="btn btn-danger mt-3">–í—ã–π—Ç–∏</button>
        </div>
    </div>
</div>

<th:block layout:fragment="custom-js">
    <script>
        // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø—Ä–∏ –≤—Ö–æ–¥–µ
        const token = localStorage.getItem('jwtToken');
        const apiDataElement = document.getElementById('apiData');

        // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
        if (!token) {
            alert('–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Å–µ–∞–Ω—Å–∞ –∏—Å—Ç–µ–∫ –∏–ª–∏ –≤—ã –Ω–µ –≤–æ—à–ª–∏. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –≤—Ö–æ–¥.');
            window.location.href = '/login';
        }

        // 1. –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞—â–∏—â–µ–Ω–Ω–æ–≥–æ API
        document.getElementById('testApiButton').addEventListener('click', async function() {
            apiDataElement.innerText = '–ó–∞–≥—Ä—É–∑–∫–∞...';

            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –∑–∞—â–∏—â–µ–Ω–Ω—É—é –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫—É
                const response = await fetch('/api/test/user', {
                    method: 'GET',
                    headers: {
                        // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –î–æ–±–∞–≤–ª—è–µ–º JWT –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫ Authorization
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    apiDataElement.innerText = JSON.stringify(data, null, 2);
                    apiDataElement.style.backgroundColor = '#d4edda'; // –ó–µ–ª–µ–Ω—ã–π —Ñ–æ–Ω —É—Å–ø–µ—Ö–∞
                } else if (response.status === 401 || response.status === 403) {
                    apiDataElement.innerText = `–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω (${response.status}). –¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.`;
                    apiDataElement.style.backgroundColor = '#f8d7da'; // –ö—Ä–∞—Å–Ω—ã–π —Ñ–æ–Ω –æ—à–∏–±–∫–∏
                } else {
                    apiDataElement.innerText = `–û—à–∏–±–∫–∞ ${response.status}: ${response.statusText}`;
                    apiDataElement.style.backgroundColor = '#f8d7da';
                }

            } catch (error) {
                apiDataElement.innerText = '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ API: ' + error.message;
                apiDataElement.style.backgroundColor = '#f8d7da';
            }
        });

        // 2. –õ–æ–≥–∏–∫–∞ –≤—ã—Ö–æ–¥–∞
        document.getElementById('logoutButton').addEventListener('click', function() {
            localStorage.removeItem('jwtToken');
            alert('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã.');
            window.location.href = '/login';
        });

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.getElementById('testApiButton').click();
    </script>
</th:block>
</body>
</html>